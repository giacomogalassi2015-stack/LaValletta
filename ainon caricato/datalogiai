console.log("‚úÖ 1. data-logic.js caricato");

// 1. CONFIGURAZIONE SUPABASE
const SUPABASE_URL = 'https://ydrpicezcwtfwdqpihsb.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkcnBpY2V6Y3d0ZndkcXBpaHNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNTQzMDAsImV4cCI6MjA4MzYzMDMwMH0.c89-gAZ8Pgp5Seq89BYRraTG-qqmP03LUCl1KqG9bOg';

// RENDIAMO SUPABASE GLOBALE
window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// INIZIALIZZAZIONE CACHE
window.appCache = {};

const CLOUDINARY_CLOUD_NAME = 'dkg0jfady'; 
const CLOUDINARY_BASE_URL = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/`;

// 2. VARIABILI GLOBALI
window.mapsToInit = [];
window.tempTransportData = [];
window.tempAttractionsData = [];
window.currentLang = localStorage.getItem('app_lang') || 'it';
window.currentViewName = 'home'; // Tracciamento vista per header

// 3. CONFIGURAZIONE LINGUE
window.AVAILABLE_LANGS = [
    { code: 'it', label: 'Italiano', flag: 'üáÆüáπ' },
    { code: 'en', label: 'English', flag: 'üá¨üáß' },
    { code: 'fr', label: 'Fran√ßais', flag: 'üá´üá∑' },
    { code: 'de', label: 'Deutsch', flag: 'üá©üá™' },
    { code: 'es', label: 'Espa√±ol', flag: 'üá™üá∏' },
    { code: 'zh', label: '‰∏≠Êñá', flag: 'üá®üá≥' }
];

// 4. DIZIONARIO TESTI (Full Version - Aggiornato con Mezzi)
const UI_TEXT = {
    it: {
        loading: "Caricamento...", error: "Errore", no_results: "Nessun risultato.",
        // Menu & Nav
        home_title: "Benvenuto", nav_villages: "Home", nav_food: "Cibo", nav_outdoor: "Outdoor", nav_services: "Servizi",
        menu_prod: "Prodotti", menu_rest: "Ristoranti", menu_trail: "Sentieri", menu_beach: "Spiagge", 
        menu_trans: "Trasporti", menu_num: "Numeri Utili", menu_pharm: "Farmacie", menu_map: "Mappe", menu_monu: "Attrazioni",
        menu_wine: "Vini", menu_legal: "Note Legali",
        // NOMI MEZZI (Nuovi)
        label_bus: "Bus Navetta", label_ferry: "Battello", label_train: "Treno",
        // Footer
        footer_rights: "Tutti i diritti riservati.",
        // Filtri
        filter_title: "Filtra per", filter_all: "Tutti", show_results: "Mostra Risultati", 
        filter_cat: "Categoria", filter_village: "Borgo",
        // Vini & Schede
        wine_type: "Tipologia", wine_grapes: "Uve", wine_pairings: "Abbinamenti", wine_deg: "Gradi",
        label_curiosity: "Curiosit√†", desc_missing: "Descrizione non disponibile.",
        // Azioni Generiche
        btn_details: "Vedi Dettagli", btn_download_gpx: "Scarica file GPX", 
        gpx_missing: "Traccia GPS non presente",
        map_route_title: "Mappa Percorso", map_zoom_hint: "Usa due dita per zoomare",
        // Trasporti
        plan_trip: "Pianifica Viaggio", departure: "PARTENZA", arrival: "ARRIVO", 
        date_trip: "DATA VIAGGIO", time_trip: "ORARIO", find_times: "TROVA ORARI",
        next_runs: "CORSE SUCCESSIVE", next_departure: "PROSSIMA PARTENZA",
        select_placeholder: "Seleziona...", select_start: "-- Seleziona Partenza --",
        bus_searching: "Cerco collegamenti...", bus_no_conn: "Nessun collegamento", 
        bus_no_dest: "Nessuna destinazione", bus_not_found: "Nessuna corsa trovata",
        bus_try_change: "Prova a cambiare orario.", 
        badge_holiday: "üìÖ FESTIVO", badge_weekday: "üè¢ FERIALE",
        label_warning: "ATTENZIONE",
        how_to_ticket: "COME ACQUISTARE IL BIGLIETTO",
        show_map: "MOSTRA MAPPA", hide_map: "NASCONDI MAPPA",
        map_hint: "Tocca i segnaposto per impostare Partenza/Arrivo",
        train_cta: "ORARI E BIGLIETTI",
        train_desc: "Il treno √® il mezzo pi√π veloce. Corse frequenti ogni 15-20 minuti tra i borghi.",
        avg_times: "Tempi Medi", between_villages: "Tra i Borghi", check_site: "Acquista e controlla gli orari sul sito ufficiale",
        ideal_for: "Ideale per",
        welcome_app_name: "5 Terre Guide", welcome_desc: "La tua guida essenziale per esplorare le Cinque Terre."
    },
    en: {
        loading: "Loading...", error: "Error", no_results: "No results found.",
        home_title: "Welcome", nav_villages: "Home", nav_food: "Food", nav_outdoor: "Outdoor", nav_services: "Services",
        menu_prod: "Products", menu_rest: "Restaurants", menu_trail: "Trails", menu_beach: "Beaches", 
        menu_trans: "Transport", menu_num: "Useful Numbers", menu_pharm: "Pharmacies", menu_map: "Maps", menu_monu: "Attractions",
        menu_wine: "Wines", menu_legal: "Legal & Privacy",
        // NAMES (New)
        label_bus: "Shuttle Bus", label_ferry: "Ferry", label_train: "Train",
        footer_rights: "All rights reserved.",
        filter_title: "Filter by", filter_all: "All", show_results: "Show Results", 
        filter_cat: "Category", filter_village: "Village",
        wine_type: "Type", wine_grapes: "Grapes", wine_pairings: "Pairings", wine_deg: "Alcohol",
        label_curiosity: "Curiosity", desc_missing: "Description not available.",
        btn_details: "See Details", btn_download_gpx: "Download GPX file", 
        gpx_missing: "GPS track not found",
        map_route_title: "Route Map", map_zoom_hint: "Use two fingers to zoom",
        plan_trip: "Plan Trip", departure: "DEPARTURE", arrival: "ARRIVAL", 
        date_trip: "DATE", time_trip: "TIME", find_times: "FIND TIMES",
        next_runs: "NEXT RUNS", next_departure: "NEXT DEPARTURE",
        select_placeholder: "Select...", select_start: "-- Select Departure --",
        bus_searching: "Searching...", bus_no_conn: "No connection", 
        bus_no_dest: "No destination", bus_not_found: "No runs found",
        bus_try_change: "Try changing time.", 
        badge_holiday: "üìÖ HOLIDAY", badge_weekday: "üè¢ WEEKDAY",
        label_warning: "WARNING",
        how_to_ticket: "HOW TO BUY TICKETS",
        show_map: "SHOW MAP", hide_map: "HIDE MAP",
        map_hint: "Tap markers to set Departure/Arrival",
        train_cta: "TIMETABLE & TICKETS",
        train_desc: "The train is the fastest way. Frequent runs every 15-20 mins between villages.",
        avg_times: "Avg Times", between_villages: "Between Villages", check_site: "Buy and check times on the official site",
        ideal_for: "Best for",
        welcome_app_name: "5 Terre Guide", welcome_desc: "Your essential guide to exploring Cinque Terre."
    },
    fr: {
        loading: "Chargement...", error: "Erreur", no_results: "Aucun r√©sultat.",
        home_title: "Bienvenue", nav_villages: "Accueil", nav_food: "Nourriture", nav_outdoor: "Plein Air", nav_services: "Services",
        menu_prod: "Produits", menu_rest: "Restaurants", menu_trail: "Sentiers", menu_beach: "Plages", menu_wine: "Vins",
        menu_trans: "Transport", menu_num: "Num√©ros", menu_pharm: "Pharmacies", menu_map: "Cartes", menu_monu: "Attractions",
        menu_legal: "Mentions L√©gales",
        // NOMS (New)
        label_bus: "Navette", label_ferry: "Bateau", label_train: "Train",
        footer_rights: "Tous droits r√©serv√©s.",
        filter_title: "Filtrer par", filter_all: "Tous", show_results: "Voir R√©sultats", 
        filter_cat: "Cat√©gorie", filter_village: "Village",
        wine_type: "Type", wine_grapes: "Raisins", wine_pairings: "Accords", wine_deg: "Alcool",
        label_curiosity: "Curiosit√©", desc_missing: "Description non disponible.",
        btn_details: "Voir D√©tails", btn_download_gpx: "T√©l√©charger GPX", 
        gpx_missing: "Trace GPS non trouv√©e",
        map_route_title: "Carte itin√©raire", map_zoom_hint: "Utilisez deux doigts pour zoomer",
        plan_trip: "Planifier", departure: "D√âPART", arrival: "ARRIV√âE", 
        date_trip: "DATE", time_trip: "HEURE", find_times: "CHERCHER",
        next_runs: "PROCHAINS D√âPARTS", next_departure: "PROCHAIN D√âPART",
        select_placeholder: "S√©lectionner...", select_start: "-- Choisir D√©part --",
        bus_searching: "Recherche...", bus_no_conn: "Aucune connexion", 
        bus_no_dest: "Aucune destination", bus_not_found: "Aucun trajet trouv√©",
        bus_try_change: "Essayez de changer l'heure.", 
        badge_holiday: "üìÖ F√âRI√â", badge_weekday: "üè¢ SEMAINE",
        label_warning: "ATTENTION",
        how_to_ticket: "COMMENT ACHETER UN BILLET",
        show_map: "AFFICHER CARTE", hide_map: "MASQUER CARTE",
        map_hint: "Touchez les marqueurs pour d√©finir D√©part/Arriv√©e",
        train_cta: "HORAIRES & BILLETS",
        train_desc: "Le train est le moyen le plus rapide. Passages fr√©quents toutes les 15-20 min.",
        avg_times: "Temps Moyens", between_villages: "Entre Villages", check_site: "Achetez et v√©rifiez les horaires sur le site officiel",
        ideal_for: "Id√©al pour",
        welcome_app_name: "5 Terre Guide", welcome_desc: "Votre guide essentiel pour explorer les Cinque Terre."
    },
    de: {
        loading: "Laden...", error: "Fehler", no_results: "Keine Ergebnisse.",
        home_title: "Willkommen", nav_villages: "Start", nav_food: "Essen", nav_outdoor: "Outdoor", nav_services: "Dienste",
        menu_prod: "Produkte", menu_rest: "Restaurants", menu_trail: "Wanderwege", menu_beach: "Str√§nde", menu_wine: "Weine",
        menu_trans: "Transport", menu_num: "Nummern", menu_pharm: "Apotheken", menu_map: "Karten", menu_monu: "Attraktionen",
        menu_legal: "Recht & Datenschutz",
        // NAMEN (New)
        label_bus: "Shuttlebus", label_ferry: "F√§hre", label_train: "Zug",
        footer_rights: "Alle Rechte vorbehalten.",
        filter_title: "Filtern nach", filter_all: "Alle", show_results: "Ergebnisse anzeigen", 
        filter_cat: "Kategorie", filter_village: "Dorf",
        wine_type: "Typ", wine_grapes: "Trauben", wine_pairings: "Paarungen", wine_deg: "Alkohol",
        label_curiosity: "Kuriosit√§t", desc_missing: "Beschreibung nicht verf√ºgbar.",
        btn_details: "Details ansehen", btn_download_gpx: "GPX herunterladen", 
        gpx_missing: "GPS-Track nicht gefunden",
        map_route_title: "Routenkarte", map_zoom_hint: "Mit zwei Fingern zoomen",
        plan_trip: "Planen", departure: "ABFAHRT", arrival: "ANKUNFT", 
        date_trip: "DATUM", time_trip: "ZEIT", find_times: "SUCHEN",
        next_runs: "N√ÑCHSTE FAHRTEN", next_departure: "N√ÑCHSTE ABFAHRT",
        select_placeholder: "W√§hlen...", select_start: "-- Abfahrt w√§hlen --",
        bus_searching: "Suche...", bus_no_conn: "Keine Verbindung", 
        bus_no_dest: "Kein Ziel", bus_not_found: "Keine Fahrten gefunden",
        bus_try_change: "Versuchen Sie eine andere Zeit.", 
        badge_holiday: "üìÖ FEIERTAG", badge_weekday: "üè¢ WERKTAG",
        label_warning: "ACHTUNG",
        how_to_ticket: "TICKET KAUFEN",
        show_map: "KARTE ANZEIGEN", hide_map: "KARTE AUSBLENDEN",
        map_hint: "Tippen Sie auf Marker f√ºr Start/Ziel",
        train_cta: "FAHRPL√ÑNE & TICKETS",
        train_desc: "Der Zug ist am schnellsten. H√§ufige Fahrten alle 15-20 Min.",
        avg_times: "Durchschn. Zeit", between_villages: "Zwischen D√∂rfern", check_site: "Kaufen und pr√ºfen Sie Zeiten auf der offiziellen Seite",
        ideal_for: "Ideal f√ºr",
        welcome_app_name: "5 Terre Guide", welcome_desc: "Ihr wesentlicher Reisef√ºhrer f√ºr die Cinque Terre."
    },
    es: {
        loading: "Cargando...", error: "Error", no_results: "Sin resultados.",
        home_title: "Bienvenido", nav_villages: "Inicio", nav_food: "Comida", nav_outdoor: "Aire Libre", nav_services: "Servicios",
        menu_prod: "Productos", menu_rest: "Restaurantes", menu_trail: "Senderos", menu_beach: "Playas", menu_wine: "Vinos",
        menu_trans: "Transporte", menu_num: "N√∫meros", menu_pharm: "Farmacias", menu_map: "Mapas", menu_monu: "Atracciones",
        menu_legal: "Legal y Privacidad",
        // NOMBRES (New)
        label_bus: "Microb√∫s", label_ferry: "Barco", label_train: "Tren",
        footer_rights: "Todos los derechos reservados.",
        filter_title: "Filtrar por", filter_all: "Todos", show_results: "Mostrar Resultados", 
        filter_cat: "Categor√≠a", filter_village: "Pueblo",
        wine_type: "Tipo", wine_grapes: "Uvas", wine_pairings: "Maridaje", wine_deg: "Alcohol",
        label_curiosity: "Curiosidad", desc_missing: "Descripci√≥n no disponible.",
        btn_details: "Ver Detalles", btn_download_gpx: "Descargar GPX", 
        gpx_missing: "Ruta GPS no encontrada",
        map_route_title: "Mapa de Ruta", map_zoom_hint: "Usa dos dedos para hacer zoom",
        plan_trip: "Planificar", departure: "SALIDA", arrival: "LLEGADA", 
        date_trip: "FECHA", time_trip: "HORA", find_times: "BUSCAR",
        next_runs: "PR√ìXIMAS SALIDAS", next_departure: "PR√ìXIMA SALIDA",
        select_placeholder: "Seleccionar...", select_start: "-- Seleccionar Salida --",
        bus_searching: "Buscando...", bus_no_conn: "Sin conexi√≥n", 
        bus_no_dest: "Sin destino", bus_not_found: "No se encontraron viajes",
        bus_try_change: "Prueba a cambiar la hora.", 
        badge_holiday: "üìÖ FESTIVO", badge_weekday: "üè¢ LABORAL",
        label_warning: "ATENCI√ìN",
        how_to_ticket: "C√ìMO COMPRAR BOLETO",
        show_map: "MOSTRAR MAPA", hide_map: "OCULTAR MAPA",
        map_hint: "Toca marcadores para configurar Salida/Llegada",
        train_cta: "HORARIOS Y BOLETOS",
        train_desc: "El tren es el medio m√°s r√°pido. Frecuencia cada 15-20 min.",
        avg_times: "Tiempos Promedio", between_villages: "Entre Pueblos", check_site: "Compra y consulta horarios en el sitio oficial",
        ideal_for: "Ideal para",
        welcome_app_name: "5 Terre Guide", welcome_desc: "Tu gu√≠a esencial para explorar Cinque Terre."
    },
    zh: {
        loading: "Âä†ËΩΩ‰∏≠...", error: "ÈîôËØØ", no_results: "Êó†ÁªìÊûú",
        home_title: "Ê¨¢Ëøé", nav_villages: "È¶ñÈ°µ", nav_food: "ÁæéÈ£ü", nav_outdoor: "Êà∑Â§ñ", nav_services: "ÊúçÂä°",
        menu_prod: "‰∫ßÂìÅ", menu_rest: "È§êÂéÖ", menu_trail: "Ê≠•ÈÅì", menu_beach: "Êµ∑Êª©", menu_wine: "Ëë°ËêÑÈÖí",
        menu_trans: "‰∫§ÈÄö", menu_num: "Â∏∏Áî®Âè∑Á†Å", menu_pharm: "ËçØÊàø", menu_map: "Âú∞Âõæ", menu_monu: "ÊôØÁÇπ",
        menu_legal: "Ê≥ïÂæã‰∏éÈöêÁßÅ",
        // ÂêçÁß∞ (New)
        label_bus: "Á©øÊ¢≠Â∑¥Â£´", label_ferry: "Ê∏°ËΩÆ", label_train: "ÁÅ´ËΩ¶",
        footer_rights: "ÁâàÊùÉÊâÄÊúâ„ÄÇ",
        filter_title: "Á≠õÈÄâ", filter_all: "ÂÖ®ÈÉ®", show_results: "ÊòæÁ§∫ÁªìÊûú", 
        filter_cat: "Á±ªÂà´", filter_village: "ÊùëÂ∫Ñ",
        wine_type: "Á±ªÂûã", wine_grapes: "Ëë°ËêÑ", wine_pairings: "Êê≠ÈÖç", wine_deg: "ÈÖíÁ≤æÂ∫¶",
        label_curiosity: "Ë∂£Èóª", desc_missing: "ÊöÇÊó†ÊèèËø∞„ÄÇ",
        btn_details: "Êü•ÁúãËØ¶ÊÉÖ", btn_download_gpx: "‰∏ãËΩΩ GPX", 
        gpx_missing: "Êú™ÊâæÂà∞ GPS ËΩ®Ëøπ",
        map_route_title: "Ë∑ØÁ∫øÂõæ", map_zoom_hint: "‰ΩøÁî®ÂèåÊåáÁº©Êîæ",
        plan_trip: "Ë°åÁ®ãËßÑÂàí", departure: "Âá∫Âèë", arrival: "Âà∞Ëææ", 
        date_trip: "Êó•Êúü", time_trip: "Êó∂Èó¥", find_times: "Êü•ËØ¢",
        next_runs: "ÂêéÁª≠Áè≠Ê¨°", next_departure: "‰∏ã‰∏ÄÁè≠",
        select_placeholder: "ÈÄâÊã©...", select_start: "-- ÈÄâÊã©Âá∫ÂèëÂú∞ --",
        bus_searching: "ÊêúÁ¥¢‰∏≠...", bus_no_conn: "Êó†ËøûÊé•", 
        bus_no_dest: "Êó†ÁõÆÁöÑÂú∞", bus_not_found: "Êú™ÊâæÂà∞Áè≠Ê¨°",
        bus_try_change: "Â∞ùËØïÊõ¥ÊîπÊó∂Èó¥„ÄÇ", 
        badge_holiday: "üìÖ ËäÇÂÅáÊó•", badge_weekday: "üè¢ Â∑•‰ΩúÊó•",
        label_warning: "Ê≥®ÊÑè",
        how_to_ticket: "Â¶Ç‰ΩïË¥≠Á•®",
        show_map: "ÊòæÁ§∫Âú∞Âõæ", hide_map: "ÈöêËóèÂú∞Âõæ",
        map_hint: "ÁÇπÂáªÊ†áËÆ∞ËÆæÁΩÆÂá∫Âèë/Âà∞Ëææ",
        train_cta: "Êó∂ÂàªË°®ÂíåË¥≠Á•®",
        train_desc: "ÁÅ´ËΩ¶ÊòØÊúÄÂø´ÁöÑÊñπÂºè„ÄÇÊØè15-20ÂàÜÈíü‰∏ÄÁè≠„ÄÇ",
        avg_times: "Âπ≥ÂùáÊó∂Èó¥", between_villages: "ÊùëÂ∫Ñ‰πãÈó¥", check_site: "Âú®ÂÆòÁΩëË¥≠‰π∞Âπ∂Êü•ÁúãÊó∂ÂàªË°®",
        ideal_for: "ÈÄÇÂêà",
        welcome_app_name: "5 Terre Guide", welcome_desc: "Êé¢Á¥¢‰∫îÊ∏îÊùëÁöÑÂøÖÂ§áÊåáÂçó„ÄÇ"
    }
};

const FERRY_STOPS = [
    { id: 'levanto', label: 'Levanto' },
    { id: 'monterosso', label: 'Monterosso' },
    { id: 'vernazza', label: 'Vernazza' },
    { id: 'corniglia', label: 'Corniglia' },
    { id: 'manarola', label: 'Manarola' },
    { id: 'riomaggiore', label: 'Riomaggiore' },
    { id: 'portovenere', label: 'Portovenere' },
    { id: 'la spezia', label: 'La Spezia' },
    { id: 'lerici', label: 'Lerici' }
];

// 5. HELPER FUNCTIONS GLOBALI
window.t = function(key) {
    const langDict = UI_TEXT[window.currentLang] || UI_TEXT['it'];
    return langDict[key] || key; // Fallback sulla chiave stessa se manca
};

window.dbCol = function(item, field) {
    if (!item || !item[field]) return '';

    let value = item[field];

    // Se Supabase restituisce il JSONB gi√† come oggetto
    if (typeof value === 'object' && value !== null) {
        // Cerca la lingua corrente, altrimenti fallback su italiano, altrimenti stringa vuota
        return value[window.currentLang] || value['it'] || '';
    }

    // Se √® ancora una stringa (es. vecchi dati o errore di parsing), la restituisce cos√¨ com'√®
    return value;
};

window.getSmartUrl = function(name, folder = '', width = 600) {
    if (!name) return 'https://via.placeholder.com/600x400?text=No+Image';
    const safeName = encodeURIComponent(name.trim()); 
    const folderPath = folder ? `${folder}/` : '';
    return `${CLOUDINARY_BASE_URL}/w_${width},c_fill,f_auto,q_auto:good,fl_progressive/${folderPath}${safeName}`;
};

window.changeLanguage = function(langCode) {
    console.log("Cambio lingua a:", langCode);
    
    // 1. Aggiorna la variabile globale
    window.currentLang = langCode;
    
    // Salva la scelta nel browser
    localStorage.setItem('user_lang', langCode);

    // 2. Aggiorna i testi statici dell'interfaccia
    updateStaticInterface();

    // 3. Ricarica la vista corrente
    if (typeof renderCategory === 'function') {
        const currentCategory = window.currentCategory || 'attrazioni'; 
        renderCategory(currentCategory); 
    } else {
        location.reload(); 
    }
};

// Funzione helper per aggiornare i testi fissi
function updateStaticInterface() {
    const homeTitleEl = document.getElementById('home-title'); 
    if(homeTitleEl) homeTitleEl.textContent = window.t('home_title');

    const navFood = document.getElementById('nav-food');
    if(navFood) navFood.textContent = window.t('nav_food');
    
    // Aggiungi qui altri elementi fissi da aggiornare
}


// Algoritmo di Gauss per calcolare la Pasqua
function getEasterDate(year) {
    const a = year % 19;
    const b = Math.floor(year / 100);
    const c = year % 100;
    const d = Math.floor(b / 4);
    const e = b % 4;
    const f = Math.floor((b + 8) / 25);
    const g = Math.floor((b - f + 1) / 3);
    const h = (19 * a + b - d - g + 15) % 30;
    const i = Math.floor(c / 4);
    const k = c % 4;
    const l = (32 + 2 * e + 2 * i - h - k) % 7;
    const m = Math.floor((a + 11 * h + 22 * l) / 451);
    
    const month = Math.floor((h + l - 7 * m + 114) / 31) - 1; // 0-indexed per JS Date
    const day = ((h + l - 7 * m + 114) % 31) + 1;
    
    return new Date(year, month, day);
}

// Verifica se √® un giorno festivo in Italia
function isItalianHoliday(dateObj) {
    const d = dateObj.getDate();
    const m = dateObj.getMonth() + 1; // 1-12
    const y = dateObj.getFullYear();

    // 1. Domenica
    if (dateObj.getDay() === 0) return true;

    // 2. Festivit√† Fisse
    const fixedHolidays = [
        "1-1",   // Capodanno
        "6-1",   // Epifania
        "25-4",  // Liberazione
        "1-5",   // Festa del Lavoro
        "2-6",   // Festa della Repubblica
        "15-8",  // Ferragosto
        "1-11",  // Ognissanti
        "8-12",  // Immacolata
        "25-12", // Natale
        "26-12"  // Santo Stefano
    ];
    if (fixedHolidays.includes(`${d}-${m}`)) return true;

    // 3. Pasquetta
    const easter = getEasterDate(y);
    const pasquetta = new Date(easter);
    pasquetta.setDate(easter.getDate() + 1);

    if (d === pasquetta.getDate() && (m - 1) === pasquetta.getMonth()) return true;
    
    return false;
}

// ==========================================================
// DATA-LOGIC.JS: METEO, TRIVIA & CERVELLO AI (Versione Ariete)
// ==========================================================

// 1. CONFIGURAZIONE AI (La tua chiave)
const CHICCO_API_KEY = "AIzaSyAo3cBZnL_avIdRk3qk0u5KiUdqBk7PU1Q"; 

// Lista dei modelli da provare in ordine di priorit√†
const GEMINI_MODELS = [
    "gemini-2.0-flash",       // Il pi√π nuovo (quello del tuo curl)
    "gemini-1.5-flash",       // Lo standard veloce
    "gemini-1.5-flash-latest",// Variante nome
    "gemini-pro"              // Il classico (fallback sicuro)
];

// 2. PERSONALIT√Ä DI CHICCO
const CHICCO_SYSTEM_PROMPT = `
SEI CHICCO:
Sei un simpatico chicco d'uva, mascotte delle Cinque Terre. Parli in modo allegro, semplice e dai del tu. Usi qualche espressione ligure ogni tanto (es: "belin", "fante", "pria").

LE TUE CONOSCENZE DI BASE:
1. PREZZI: 
   - 5 Terre Card Trekking: 7.50‚Ç¨ adulti (include bus + sentieri a pagamento).
   - Treno MS Card: da 19‚Ç¨ a 32.50‚Ç¨ (treni illimitati La Spezia-Levanto).
2. CIBO: Acciughe di Monterosso, Pesto (basilico, pinoli, aglio), Torta di riso, Sciacchetr√† (vino passito).
3. LUOGHI: Monterosso (spiaggia), Vernazza (torre), Corniglia (alto), Manarola (presepe), Riomaggiore (verticale).

ISTRUZIONI:
1. Usa i dati forniti nel CONTESTO DATI come fonte primaria.
2. Se un sentiero √® chiuso nel database, dillo chiaramente.
3. Sii breve (max 40 parole).
4. Se non sai la risposta, fai una battuta sul vino.
`;

// 3. DATI STATICI (TRIVIA)
const CHICCO_TRIVIA = [
    { text: "Lo sapevi? Lo Sciacchetr√† √® un vino dolce prodotto con uve passite al sole." },
    { text: "Sai perch√© il vino qui √® eroico? Perch√© coltiviamo l'uva su pendenze impossibili!"},
    { text: "Corniglia √® l'unico borgo che non tocca il mare. Per arrivarci ci sono 382 gradini!" },
    { text: "Il sentiero da Corniglia a Vernazza √® considerato uno dei pi√π panoramici." },
    { text: "Ricorda di convalidare il biglietto del treno se √® cartaceo!" }
];

// 4. FUNZIONE METEO + CURIOSIT√Ä (Si attiva all'apertura)
window.getChiccoRealTimeAdvice = async function() {
    try {
        const response = await fetch("https://api.open-meteo.com/v1/forecast?latitude=44.098&longitude=9.738&current=temperature_2m,relative_humidity_2m,weather_code&timezone=auto");
        const data = await response.json();
        
        const temp = Math.round(data.current.temperature_2m);
        const wmo = data.current.weather_code;
        
        let icon = "üå§Ô∏è"; let weatherDesc = "Variabile";
        if (wmo === 0) { icon = "‚òÄÔ∏è"; weatherDesc = "Sereno"; }
        else if (wmo >= 1 && wmo <= 3) { icon = "‚òÅÔ∏è"; weatherDesc = "Nuvoloso"; }
        else if (wmo >= 51) { icon = "üåßÔ∏è"; weatherDesc = "Pioggia"; }

        const weatherPhrase = `${icon} <b>${weatherDesc}</b>, ${temp}¬∞C.`;
        const randomTrivia = CHICCO_TRIVIA[Math.floor(Math.random() * CHICCO_TRIVIA.length)];

        return {
            weather: weatherPhrase,
            advice: randomTrivia.text
        };
    } catch (error) {
        return { weather: "‚òÄÔ∏è Cinque Terre", advice: "Ciao! Chiedimi qualcosa sui sentieri." };
    }
};

// 5. FUNZIONE AI (Intelligente con tentativi multipli)
window.chiediAChicco = async function(domandaUtente) {
    if (!domandaUtente || !domandaUtente.trim()) return null;

    // Raccoglie dati locali (RAG)
    const allData = [
        ...(window.dataSentieri || []),
        ...(window.dataAttrazioni || []),
        ...(window.dataSpiagge || []),
        ...(window.dataRistoranti || [])
    ];

    const item = allData.find(x => {
        const nome = x.Nome || x.Titolo || "";
        return nome && domandaUtente.toLowerCase().includes(nome.toLowerCase());
    });

    let contesto = "";
    if (item) {
        const desc = item.Descrizione || item.descrizione || "";
        const stato = item.Stato ? `Stato: ${item.Stato}` : "";
        contesto = `INFO DATABASE SU "${item.Nome}": ${stato}. ${desc}`;
    }

    const prompt = `
    ${CHICCO_SYSTEM_PROMPT}
    CONTESTO DATI: ${contesto || "Nessun dato specifico."}
    DOMANDA: ${domandaUtente}
    RISPOSTA:
    `;

    // --- LOGICA DI TENTATIVO MULTIPLO ---
    for (let model of GEMINI_MODELS) {
        try {
            console.log(`üì° Tento connessione con modello: ${model}...`);
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${CHICCO_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            if (response.ok) {
                const data = await response.json();
                console.log(`‚úÖ Successo con ${model}!`);
                return data.candidates[0].content.parts[0].text;
            } else {
                console.warn(`‚ùå Fallito ${model} con status ${response.status}`);
                // Se √® 404 continua al prossimo modello nel ciclo
                if (response.status !== 404 && response.status !== 400) {
                    throw new Error(`Errore API ${response.status}`);
                }
            }
        } catch (err) {
            console.error(`Errore durante tentativo con ${model}:`, err);
        }
    }

    // Se arriviamo qui, nessuno dei modelli ha funzionato
    return "Belin, sembra che Google sia in sciopero oggi! (Tutti i modelli AI hanno fallito).";
};
